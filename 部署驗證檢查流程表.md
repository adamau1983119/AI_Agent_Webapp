# 部署驗證檢查流程表

> **用途**：驗證代碼修改是否正確部署到生產環境  
> **適用場景**：每次代碼修改後、部署後、問題排查時  
> **更新日期**：2026-01-06

---

## 📋 檢查流程總覽

```
Git 推送 → Railway 檢測 → Railway 部署 → 代碼生效 → 功能正常
   ✅          ❓              ❓            ❓           ❓
```

---

## 🔍 步驟 0：前置檢查（部署前）

### 0.1 Git 推送驗證

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| 本地代碼已提交 | commit hash 存在 | `ad35f98` | ✅ | 使用 `git log --oneline -1` |
| GitHub 最新 commit | 與本地一致 | ✅ `ad35f98` | ✅ | Git fetch 成功，已驗證一致 |
| Git 推送成功 | 無錯誤訊息 | ✅ 可以推送 | ✅ | Git 倉庫已修復，操作正常 |
| Commit 訊息正確 | 包含修改說明 | ⚠️ 部分編碼問題（歷史記錄） | ⚠️ | 新提交將使用 UTF-8 編碼 |

**如果不一致**：
- [x] 重新推送代碼 - ✅ **已完成**（Git 倉庫已修復）
- [x] 檢查 Git 倉庫連接 - ✅ **已修復**（從遠程恢復 .git 目錄）
- [x] 確認遠程倉庫地址 - ✅ `https://github.com/adamau1983119/AI_Agent_Webapp.git`

**✅ 修復完成**：
- ✅ **Git 倉庫已修復**：已從遠程倉庫恢復 .git 目錄，所有操作正常
- 🟡 **未追蹤文件**：多個文件未提交（包括文檔和測試文件），待處理
- 🟡 **Commit 編碼問題**：歷史記錄仍有編碼問題，新提交已設置 UTF-8 編碼

**📋 詳細診斷報告**：請參閱 `Git問題診斷報告.md`

---

### 0.2 Railway 連接配置檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| Railway 連接的倉庫 | `adamau1983119/AI_Agent_Webapp` | | ⬜ | Railway Dashboard → Settings → Source |
| Railway 監聽的分支 | `main` | | ⬜ | Railway Dashboard → Settings → Source |
| 自動部署已啟用 | Enabled | | ⬜ | Railway Dashboard → Settings → Source |
| Railway 服務狀態 | Running | | ⬜ | Railway Dashboard → Overview |

**如果配置錯誤**：
- [ ] 更新 Railway 連接配置
- [ ] 重新連接 GitHub 倉庫
- [ ] 確認分支設置

---

## 🔍 步驟 1：確認部署版本（部署後）

### 1.1 Railway 部署狀態檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| 最新部署的 commit hash | 與 GitHub 最新 commit 一致 | | ⬜ | Railway Dashboard → Deployments |
| 部署狀態 | Success | | ⬜ | Railway Dashboard → Deployments |
| 部署時間 | 在 Git 推送之後 | | ⬜ | Railway Dashboard → Deployments |
| Build Logs 無錯誤 | 構建成功 | | ⬜ | Railway Dashboard → Deployments → Build Logs |
| Deploy Logs 無錯誤 | 部署成功 | | ⬜ | Railway Dashboard → Deployments → Deploy Logs |

**如果不一致**：
- [ ] 手動觸發 Railway 重新部署
- [ ] 檢查 Build Logs 找出錯誤
- [ ] 檢查 Deploy Logs 找出錯誤
- [ ] 確認 Railway 連接配置

---

### 1.2 版本一致性驗證

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| GitHub 最新 commit | `ad35f98` (或最新) | | ⬜ | GitHub 倉庫頁面 |
| Railway 部署的 commit | 與 GitHub 一致 | | ⬜ | Railway Dashboard → Deployments |
| 本地最新 commit | 與 GitHub 一致 | | ⬜ | 使用 `git log --oneline -1` |

**如果不一致**：
- [ ] 確認 Git 推送是否成功
- [ ] 確認 Railway 是否檢測到新 commit
- [ ] 手動觸發 Railway 重新部署

---

## 🔍 步驟 2：檢查代碼是否生效（運行時）

### 2.1 啟動日誌檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| 看到 `=== 啟動環境變數驗證 ===` | 存在 | | ⬜ | Railway Dashboard → Logs |
| 看到 `AI_SERVICE: deepseek` | 存在 | | ⬜ | Railway Dashboard → Logs |
| 看到 `✅ DEEPSEEK_API_KEY 存在` 或 `⚠️ DEEPSEEK_API_KEY 不存在` | 存在 | | ⬜ | Railway Dashboard → Logs |
| 看到 `✅ GOOGLE_API_KEY 存在` 或 `⚠️ GOOGLE_API_KEY 不存在` | 存在 | | ⬜ | Railway Dashboard → Logs |
| 看到 `✅ GOOGLE_SEARCH_ENGINE_ID 存在` 或 `⚠️ GOOGLE_SEARCH_ENGINE_ID 不存在` | 存在 | | ⬜ | Railway Dashboard → Logs |
| 看到 `=== 環境變數驗證完成 ===` | 存在 | | ⬜ | Railway Dashboard → Logs |
| 日誌時間戳最新 | 在部署時間之後 | | ⬜ | Railway Dashboard → Logs |

**如果沒有新日誌**：
- [ ] 檢查是否查看正確的日誌位置（Runtime Logs）
- [ ] 檢查日誌是否被截斷
- [ ] 確認部署是否真的成功
- [ ] 手動觸發重新部署

---

### 2.2 環境變數狀態檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| `AI_SERVICE` | `deepseek` | | ⬜ | 從啟動日誌確認 |
| `DEEPSEEK_API_KEY` | 存在（✅） | | ⬜ | 從啟動日誌確認 |
| `GOOGLE_API_KEY` | 存在（✅） | | ⬜ | 從啟動日誌確認 |
| `GOOGLE_SEARCH_ENGINE_ID` | 存在（✅） | | ⬜ | 從啟動日誌確認 |
| 圖片服務配置 | 至少一個已配置 | | ⬜ | 從啟動日誌確認 |

**如果環境變數缺失**：
- [ ] 在 Railway Dashboard → Variables 中設置
- [ ] 觸發重新部署使環境變數生效
- [ ] 確認環境變數名稱拼寫正確

---

## 🔍 步驟 3：測試功能是否正常（運行時）

### 3.1 API 端點可訪問性檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| `/health` 端點可訪問 | 200 OK | | ⬜ | `curl https://<railway-url>/health` |
| `/api/v1/validate/images` 端點可訪問 | 200 OK | | ⬜ | `curl https://<railway-url>/api/v1/validate/images` |
| 響應時間正常 | < 2 秒 | | ⬜ | 檢查響應時間 |

**如果端點不可訪問**：
- [ ] 檢查 Railway 服務是否運行
- [ ] 檢查 Railway URL 是否正確
- [ ] 檢查網路連接
- [ ] 檢查 Railway Logs 中的錯誤訊息

---

### 3.2 API 響應結構檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| `/api/v1/validate/images` 響應結構 | JSON 格式正確 | | ⬜ | 檢查響應格式 |
| 包含 `unsplash` 欄位 | `true` 或 `false` | | ⬜ | 檢查響應數據 |
| 包含 `pexels` 欄位 | `true` 或 `false` | | ⬜ | 檢查響應數據 |
| 包含 `pixabay` 欄位 | `true` 或 `false` | | ⬜ | 檢查響應數據 |
| 包含 `google_api_key` 欄位 | `true` 或 `false` | | ⬜ | 檢查響應數據 |
| 包含 `google_search_engine_id` 欄位 | `true` 或 `false` | | ⬜ | 檢查響應數據 |
| 包含 `duckduckgo` 欄位 | `true` | | ⬜ | 檢查響應數據 |
| 包含 `available_services` 欄位 | 陣列格式 | | ⬜ | 檢查響應數據 |

**如果響應結構錯誤**：
- [ ] 確認代碼是否正確部署
- [ ] 檢查 API 路由配置
- [ ] 檢查 Railway Logs 中的錯誤訊息

---

### 3.3 API 響應數據檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| `available_services` 包含 `duckduckgo` | `true` | | ⬜ | 檢查響應數據 |
| `available_services` 包含已配置的服務 | 根據環境變數 | | ⬜ | 檢查響應數據 |
| 響應數據與環境變數一致 | 一致 | | ⬜ | 對比啟動日誌 |

**如果響應數據錯誤**：
- [ ] 確認環境變數是否正確設置
- [ ] 確認代碼邏輯是否正確
- [ ] 檢查 Railway Logs 中的錯誤訊息

---

## 🔍 步驟 4：環境變數驗證（運行時）

### 4.1 環境變數實際值檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| `DEEPSEEK_API_KEY` 值有效 | 不為空且格式正確 | | ⬜ | Railway Dashboard → Variables |
| `GOOGLE_API_KEY` 值有效 | 不為空且格式正確 | | ⬜ | Railway Dashboard → Variables |
| `GOOGLE_SEARCH_ENGINE_ID` 值有效 | 不為空且格式正確 | | ⬜ | Railway Dashboard → Variables |
| 環境變數更新後觸發重新部署 | 已觸發 | | ⬜ | Railway Dashboard → Deployments |

**如果環境變數無效**：
- [ ] 更新 Railway Dashboard → Variables
- [ ] 確認 API Key 格式正確
- [ ] 確認 API Key 未過期
- [ ] 觸發重新部署

---

### 4.2 環境變數同步檢查

| 檢查項目 | 預期結果 | 實際結果 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| Railway 環境變數與代碼預期一致 | 一致 | | ⬜ | 對比代碼和 Railway Dashboard |
| 環境變數更新後代碼能讀取 | 能讀取 | | ⬜ | 檢查啟動日誌 |
| 環境變數更新後功能正常 | 功能正常 | | ⬜ | 測試 API 端點 |

**如果不同步**：
- [ ] 確認環境變數名稱拼寫正確
- [ ] 確認環境變數值格式正確
- [ ] 觸發重新部署使環境變數生效

---

## 📊 檢查結果總結

### 檢查狀態說明

- ✅ **通過**：檢查項目符合預期
- ❌ **失敗**：檢查項目不符合預期，需要處理
- ⚠️ **警告**：檢查項目部分符合預期，需要注意
- ⬜ **未檢查**：尚未執行檢查

---

### 檢查結果記錄

**檢查日期**：2026-01-07  
**檢查人員**：Auto AI Assistant  
**Git Commit Hash**：`ad35f98`（本地與遠程一致）  
**Railway Deploy Hash**：未檢查

**今日工作總結**：
- ✅ **Git 倉庫修復完成**：已從遠程倉庫恢復 .git 目錄
- ✅ Git fetch/push 操作正常
- ✅ 遠程追蹤已建立
- ✅ Git 編碼設置已配置（UTF-8）
- 🟡 未追蹤文件待處理
- 📋 詳細記錄請參閱：`今日工作記錄_2026-01-06.md`
- 📋 待辦清單請參閱：`明日待辦清單_2026-01-07.md`

**步驟 0：前置檢查**
- Git 推送驗證：✅ **已修復**（Git 倉庫已恢復，fetch/push 正常）
- Railway 連接配置：⬜ **待檢查**

**步驟 1：確認部署版本**
- Railway 部署狀態：⬜
- 版本一致性：⬜

**步驟 2：檢查代碼是否生效**
- 啟動日誌檢查：⬜
- 環境變數狀態：⬜

**步驟 3：測試功能是否正常**
- API 端點可訪問性：⬜
- API 響應結構：⬜
- API 響應數據：⬜

**步驟 4：環境變數驗證**
- 環境變數實際值：⬜
- 環境變數同步：⬜

---

### 問題記錄

| 問題描述 | 發現步驟 | 處理方法 | 狀態 | 備註 |
|---------|---------|---------|------|------|
| Git 倉庫損壞（對象庫損壞，無法 fetch/push） | 步驟 0.1 | 從遠程倉庫恢復 .git 目錄 | ✅ 已修復 | 2026-01-07 修復完成 |
| 未追蹤文件（多個文件未提交） | 步驟 0.1 | 決定是否提交或添加到 .gitignore | 🟡 待處理 | 包括文檔和測試文件 |
| Commit 訊息編碼問題（顯示亂碼） | 步驟 0.1 | 已設置 UTF-8 編碼配置 | ✅ 已設置 | 新提交將使用正確編碼 |

---

## 🚀 快速檢查清單（簡化版）

### 必須檢查的項目（每次部署後）

- [ ] **步驟 1.1**：Railway 最新部署的 commit hash 與 GitHub 一致
- [ ] **步驟 2.1**：Railway Logs 中看到 `=== 啟動環境變數驗證 ===`
- [ ] **步驟 3.1**：`/api/v1/validate/images` 端點可訪問
- [ ] **步驟 3.2**：API 響應結構正確

### 如果以上都通過，但功能仍不正常

- [ ] **步驟 4.1**：檢查環境變數實際值是否有效
- [ ] **步驟 4.2**：確認環境變數更新後是否觸發重新部署

---

## 📝 使用說明

### 何時使用此檢查表

1. **每次代碼修改後**：確認修改是否正確部署
2. **每次部署後**：驗證部署是否成功
3. **問題排查時**：系統化檢查問題原因
4. **定期檢查**：確保系統正常運行

### 如何使用

1. **執行檢查**：按照步驟順序逐項檢查
2. **記錄結果**：在「實際結果」欄位記錄實際情況
3. **標記狀態**：使用 ✅/❌/⚠️/⬜ 標記狀態
4. **處理問題**：如果發現問題，按照「如果不一致/如果沒有/如果錯誤」的處理方法執行
5. **記錄問題**：在「問題記錄」表格中記錄發現的問題

### 檢查頻率建議

- **每次部署後**：執行完整檢查（步驟 0-4）
- **每日檢查**：執行快速檢查清單
- **問題排查時**：執行完整檢查並記錄問題

---

**文檔版本**：v1.0  
**最後更新**：2026-01-06  
**維護人員**：開發團隊

