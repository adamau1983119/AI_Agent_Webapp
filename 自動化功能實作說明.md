# 自動化功能實作說明

## 概述

已成功實作完整的自動化功能系統，包括：
1. **主題收集器** - 從 RSS、新聞等來源自動收集熱門話題
2. **排程服務** - 使用 APScheduler 執行定時任務
3. **自動化工作流** - 主題生成後自動生成內容、搜尋圖片、準備發布
4. **排程 API** - 管理排程服務和手動觸發任務

---

## 功能說明

### 1. 主題收集器 (`TopicCollector`)

**位置**: `backend/app/services/automation/topic_collector.py`

**功能**:
- 從 RSS Feed 收集主題（時尚、美食、趨勢）
- 如果 RSS 失敗，使用備用關鍵字生成主題
- 自動提取關鍵字

**使用方式**:
```python
from app.services.automation.topic_collector import TopicCollector
from app.models.topic import Category

collector = TopicCollector()
topics = await collector.collect_topics(
    category=Category.FASHION,
    count=3,
    use_fallback=True
)
```

### 2. 自動化工作流 (`AutomationWorkflow`)

**位置**: `backend/app/services/automation/workflow.py`

**功能**:
- 自動生成內容（短文和腳本）
- 自動搜尋並添加圖片
- 完整的錯誤處理和日誌記錄

**使用方式**:
```python
from app.services.automation.workflow import AutomationWorkflow

workflow = AutomationWorkflow()
result = await workflow.process_topic(
    topic_id="topic_123",
    auto_generate_content=True,
    auto_search_images=True,
    image_count=3
)
```

### 3. 排程服務 (`SchedulerService`)

**位置**: `backend/app/services/automation/scheduler.py`

**功能**:
- 每日自動執行任務：
  - **07:00** - 生成 3 個時尚趨勢主題
  - **12:00** - 生成 3 個美食推薦主題
  - **18:00** - 生成 3 個社會趨勢主題
- 手動觸發主題生成
- 啟動/停止排程服務

**自動啟動**:
- 僅在生產環境（`ENVIRONMENT=production`）自動啟動
- 開發環境需要手動啟動（通過 API）

### 4. 排程 API

**位置**: `backend/app/api/v1/schedules.py`

**端點**:
- `GET /api/v1/schedules` - 取得排程列表
- `POST /api/v1/schedules/generate` - 手動觸發主題生成
- `POST /api/v1/schedules/start` - 啟動排程服務
- `POST /api/v1/schedules/stop` - 停止排程服務
- `GET /api/v1/schedules/status` - 取得排程服務狀態

---

## 安裝依賴

新增的依賴項已添加到 `requirements.txt`:
- `APScheduler>=3.10.4` - 排程服務
- `feedparser>=6.0.10` - RSS 解析
- `beautifulsoup4>=4.12.0` - HTML 解析（可選）

安裝命令:
```bash
pip install -r requirements.txt
```

---

## 配置說明

### 環境變數

在 `backend/.env` 或 Railway 環境變數中設定：

```env
# 環境設定（production 會自動啟動排程服務）
ENVIRONMENT=production

# AI 服務配置（選擇一個）
AI_SERVICE=qwen  # 或 ollama, ollama_cloud, gemini, openai
QWEN_API_KEY=your_api_key
# ... 其他 AI 服務配置

# 圖片服務配置（可選）
UNSPLASH_ACCESS_KEY=your_key
PEXELS_API_KEY=your_key
PIXABAY_API_KEY=your_key
```

---

## 使用方式

### 1. 自動排程（生產環境）

設定 `ENVIRONMENT=production`，應用啟動時會自動啟動排程服務。

### 2. 手動啟動排程服務

```bash
# 通過 API
curl -X POST https://your-api.com/api/v1/schedules/start

# 或在前端調用
schedulesAPI.startScheduler()
```

### 3. 手動觸發主題生成

```bash
# 通過 API
curl -X POST https://your-api.com/api/v1/schedules/generate \
  -H "Content-Type: application/json" \
  -d '{"category": "fashion", "count": 3}'

# 或在前端調用
schedulesAPI.manualGenerateTopics('fashion', 3)
```

### 4. 查看排程狀態

```bash
# 通過 API
curl https://your-api.com/api/v1/schedules/status

# 或在前端調用
schedulesAPI.getSchedulerStatus()
```

---

## 工作流程

### 自動化流程

1. **排程觸發** (07:00/12:00/18:00)
   ↓
2. **收集主題** (從 RSS 或備用關鍵字)
   ↓
3. **建立主題記錄** (保存到 MongoDB)
   ↓
4. **生成內容** (使用 AI 服務生成短文和腳本)
   ↓
5. **搜尋圖片** (根據關鍵字搜尋相關圖片)
   ↓
6. **添加圖片** (保存圖片到主題)
   ↓
7. **完成** (主題狀態為 `pending`，等待確認)

### 手動流程

用戶可以：
- 手動觸發主題生成
- 查看排程狀態
- 啟動/停止排程服務
- 查看每日排程進度

---

## 前端整合

### API 客戶端

已創建 `frontend/src/api/schedules.ts`，提供完整的排程 API 客戶端。

### 使用範例

```typescript
import { schedulesAPI } from '@/api/client'

// 取得排程列表
const schedules = await schedulesAPI.getSchedules()

// 手動觸發主題生成
await schedulesAPI.manualGenerateTopics('fashion', 3)

// 啟動排程服務
await schedulesAPI.startScheduler()

// 查看狀態
const status = await schedulesAPI.getSchedulerStatus()
```

---

## 注意事項

1. **RSS Feed 可用性**: 某些 RSS Feed 可能無法訪問，系統會自動使用備用關鍵字
2. **AI 服務配置**: 確保至少配置一個可用的 AI 服務（Qwen、Ollama、Gemini 等）
3. **圖片服務**: 如果沒有配置圖片 API Key，系統會使用 DuckDuckGo 作為備援
4. **生產環境**: 排程服務僅在生產環境自動啟動，開發環境需要手動啟動
5. **錯誤處理**: 所有步驟都有完整的錯誤處理和日誌記錄

---

## 測試建議

1. **本地測試**:
   ```bash
   # 設定開發環境
   export ENVIRONMENT=development
   
   # 啟動服務
   uvicorn app.main:app --reload
   
   # 手動觸發主題生成
   curl -X POST http://localhost:8000/api/v1/schedules/generate \
     -H "Content-Type: application/json" \
     -d '{"category": "fashion", "count": 1}'
   ```

2. **生產環境測試**:
   - 設定 `ENVIRONMENT=production`
   - 部署到 Railway
   - 檢查日誌確認排程服務已啟動
   - 等待指定時間（07:00、12:00、18:00）或手動觸發

---

## 後續改進建議

1. **更多來源**: 整合 YouTube、Twitter、Facebook 等社交媒體
2. **智能過濾**: 使用 NLP 過濾重複或低質量主題
3. **內容優化**: 根據用戶反饋優化內容生成
4. **圖片質量**: 添加圖片質量評分和過濾
5. **發布自動化**: 整合社交媒體 API 自動發布內容

---

## 問題排查

### 排程服務未啟動

1. 檢查 `ENVIRONMENT` 是否設為 `production`
2. 查看應用日誌確認是否有錯誤
3. 手動啟動排程服務測試

### 主題生成失敗

1. 檢查 AI 服務配置（API Key 是否正確）
2. 檢查 MongoDB 連接
3. 查看日誌了解具體錯誤

### RSS 收集失敗

1. 檢查網路連接
2. 確認 RSS Feed URL 是否可訪問
3. 系統會自動使用備用關鍵字，無需擔心

---

## 總結

已成功實作完整的自動化功能系統，包括：
- ✅ 主題收集器
- ✅ 自動化工作流
- ✅ 排程服務
- ✅ 排程 API
- ✅ 前端整合

系統現在可以：
- 每天自動生成 9 個主題（3 個時間段 × 每個時間段 3 個主題）
- 自動生成內容和搜尋圖片
- 手動觸發主題生成
- 管理排程服務

