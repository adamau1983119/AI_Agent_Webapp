# 生產環境排程設定指南

## ⚠️ 重要：確保每天自動生成內容

專案已正式上架，必須確保排程服務正常運行，每天自動生成內容。

---

## ✅ 必須設定的環境變數

### 1. ENVIRONMENT（最重要）

```env
ENVIRONMENT=production
```

**說明**：
- 設為 `production` 後，應用啟動時會**自動啟動排程服務**
- 排程服務會每天在指定時間自動生成主題
- 如果未設定或設為其他值，排程服務**不會自動啟動**

### 2. 時區設定

排程服務使用 **UTC 時間**，已自動轉換為香港時間（UTC+8）：

- **07:00 香港時間** = 23:00 UTC（前一天）
- **12:00 香港時間** = 04:00 UTC
- **18:00 香港時間** = 10:00 UTC

**無需額外設定**，系統已自動處理時區轉換。

### 3. 其他必要環境變數

```env
# 資料庫
MONGODB_URL=mongodb+srv://username:password@cluster.mongodb.net/...
MONGODB_DB_NAME=ai_agent_webapp

# AI 服務
AI_SERVICE=ollama  # 或 gemini, qwen, openai
OLLAMA_API_KEY=...  # 根據選擇的服務設定

# 應用設定
DEBUG=false
LOG_LEVEL=INFO
```

---

## 🔍 驗證排程服務是否運行

### 方法 1: 檢查 API 狀態

```bash
curl https://your-api-domain.com/api/v1/schedules/status
```

**預期回應**：
```json
{
  "status": "running",
  "jobs": [
    {
      "id": "fashion_topics_07:00",
      "next_run_time": "2025-12-31T23:00:00Z"
    },
    {
      "id": "food_topics_12:00",
      "next_run_time": "2026-01-01T04:00:00Z"
    },
    {
      "id": "trend_topics_18:00",
      "next_run_time": "2026-01-01T10:00:00Z"
    }
  ]
}
```

### 方法 2: 檢查日誌

在 Railway/Vercel 日誌中查找：

```
✅ 排程服務已啟動（生產環境）
✅ 排程監控服務已啟動
排程任務已設定：
  - 07:00 HKT (23:00 UTC) - 時尚趨勢
  - 12:00 HKT (04:00 UTC) - 美食推薦
  - 18:00 HKT (10:00 UTC) - 社會趨勢
```

### 方法 3: 檢查今日主題

訪問 Dashboard，查看「今日主題」卡片：
- 應該顯示 `X/9`（X 為已生成的主題數量）
- 如果顯示 `0/9`，點擊「立即生成」按鈕手動觸發

---

## 🚨 故障排除

### 問題 1: 排程服務未啟動

**症狀**：
- `GET /api/v1/schedules/status` 返回 `"status": "stopped"`
- 日誌中沒有「排程服務已啟動」訊息

**解決**：
1. 檢查 `ENVIRONMENT=production` 是否設定
2. 重啟應用（Railway 會自動重啟）
3. 或手動啟動：`POST /api/v1/schedules/start`

### 問題 2: 今日主題未生成

**症狀**：
- Dashboard 顯示 `0/9` 主題
- 排程服務狀態為 `running`

**解決**：
1. 檢查 AI 服務配置（`AI_SERVICE`、API Key）
2. 檢查 MongoDB 連接
3. 手動觸發生成：`POST /api/v1/schedules/generate-today`
4. 查看日誌中的錯誤訊息

### 問題 3: 時區問題

**症狀**：
- 主題在錯誤的時間生成
- 時間與預期不符

**解決**：
- 系統已自動處理時區轉換（UTC ↔ HKT）
- 如果仍有問題，檢查服務器時區設定

---

## 📊 監控和檢查

### 自動監控

系統已內建監控服務：
- 每 5 分鐘檢查排程服務健康狀態
- 自動檢測今日主題是否完整
- 如果主題不足，會自動觸發生成

### 手動檢查清單

每天檢查以下項目：

1. **排程服務狀態**
   ```bash
   curl https://your-api.com/api/v1/schedules/status
   ```

2. **今日主題數量**
   - 訪問 Dashboard
   - 查看「今日主題」卡片
   - 應該顯示 `9/9`（3 個分類 × 3 個主題）

3. **主題內容**
   - 訪問 `/topics` 頁面
   - 確認今日生成的主題有內容和圖片

4. **日誌檢查**
   - 查看 Railway/Vercel 日誌
   - 確認沒有錯誤訊息

---

## 🔧 手動操作（緊急情況）

### 立即生成今日所有主題

```bash
curl -X POST https://your-api.com/api/v1/schedules/generate-today \
  -H "Content-Type: application/json" \
  -d '{"force": false}'
```

### 手動啟動排程服務

```bash
curl -X POST https://your-api.com/api/v1/schedules/start
```

### 手動生成特定分類主題

```bash
curl -X POST https://your-api.com/api/v1/schedules/generate \
  -H "Content-Type: application/json" \
  -d '{"category": "fashion", "count": 3}'
```

---

## 📝 部署檢查清單

在部署到生產環境前，確認：

- [ ] `ENVIRONMENT=production` 已設定
- [ ] `MONGODB_URL` 已設定且可連接
- [ ] `AI_SERVICE` 已設定且 API Key 有效
- [ ] 排程服務狀態為 `running`
- [ ] 今日主題已生成（至少 1 個）
- [ ] 日誌中沒有錯誤訊息

---

## 🎯 預期行為

### 正常運行時

1. **應用啟動時**：
   - 自動啟動排程服務
   - 啟動監控服務
   - 檢查今日主題，如果不足會自動生成

2. **每天自動生成**：
   - **07:00 HKT**：生成 3 個時尚趨勢主題
   - **12:00 HKT**：生成 3 個美食推薦主題
   - **18:00 HKT**：生成 3 個社會趨勢主題

3. **監控服務**：
   - 每 5 分鐘檢查一次
   - 如果發現問題會記錄日誌
   - 如果主題不足會自動補生成

---

## 📞 支援

如果遇到問題：

1. 檢查日誌：Railway/Vercel 日誌
2. 檢查 API 狀態：`GET /api/v1/schedules/status`
3. 手動觸發生成：`POST /api/v1/schedules/generate-today`
4. 查看錯誤訊息並對照本文檔的故障排除部分

---

**最後更新**：2025-12-30  
**適用版本**：v1.0.0+

