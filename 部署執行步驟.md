# 部署執行步驟

> **建立日期**：2025-12-29  
> **狀態**：✅ 前端已建置完成，準備部署

---

## ✅ 已完成

- ✅ 前端建置完成（`frontend/dist/`）
- ✅ 後端檔案準備完成
- ✅ 部署配置檔案已就緒

---

## 🚀 部署步驟

### 步驟 1：部署後端到 Railway（約 15 分鐘）

#### 1.1 準備後端檔案

**需要上傳的檔案**：
- ✅ `backend/app/`（整個目錄）
- ✅ `backend/requirements.txt`
- ✅ `backend/Procfile`
- ✅ `backend/railway.json`

**不需要上傳**：
- ❌ `backend/venv/`（虛擬環境）
- ❌ `backend/__pycache__/`（Python 快取）
- ❌ `backend/.env`（敏感檔案，使用環境變數設定）

#### 1.2 建立 Railway 專案

1. **訪問 Railway**：https://railway.app
2. **登入**：使用 GitHub 帳號（或 Email）
3. **建立新專案**：
   - 點擊 "New Project"
   - 選擇 "**Empty Project**" 或 "**Deploy from GitHub repo**"
   - 如果選擇 GitHub，需要先建立一個空倉庫

#### 1.3 上傳後端檔案

**方法 A：使用 Railway CLI（推薦）**

```bash
# 1. 安裝 Railway CLI
npm install -g @railway/cli

# 2. 登入
railway login

# 3. 進入後端目錄
cd backend

# 4. 初始化專案
railway init

# 5. 連結到現有專案（或建立新專案）
railway link

# 6. 部署
railway up
```

**方法 B：使用 ZIP 上傳**

1. 壓縮以下檔案和目錄：
   - `app/`（整個目錄）
   - `requirements.txt`
   - `Procfile`
   - `railway.json`
2. 在 Railway 專案中上傳 ZIP 檔案
3. 設定 Root Directory 為 `backend`（如果上傳的是整個專案）

#### 1.4 設定環境變數

在 Railway 專案設定 → Variables 中添加：

**必須設定**：
```
MONGODB_URL=mongodb+srv://username:password@cluster.mongodb.net/?retryWrites=true&w=majority
MONGODB_DB_NAME=ai_agent_webapp
PORT=8000
AI_SERVICE=ollama
ENVIRONMENT=production
DEBUG=false
```

**強烈建議設定**：
```
API_KEY=your_secure_api_key_here
CORS_ORIGINS=["*"]
```

**可選設定**（根據您使用的服務）：
```
# AI 服務
OLLAMA_API_KEY=...
GEMINI_API_KEY=...
OPENAI_API_KEY=...

# 圖片搜尋服務
UNSPLASH_ACCESS_KEY=...
PEXELS_API_KEY=...
PIXABAY_API_KEY=...
GOOGLE_API_KEY=...
GOOGLE_SEARCH_ENGINE_ID=...
```

#### 1.5 生成公開網域

1. 在 Railway 專案中點擊 "Settings"
2. 進入 "Networking" 標籤
3. 點擊 "Generate Domain"
4. **記下網域**（例如：`your-api.railway.app`）
   - 這個網域將用於前端環境變數

#### 1.6 驗證後端部署

```bash
# 測試健康檢查
curl https://your-api.railway.app/health

# 應該返回：
# {"status":"healthy","environment":"production",...}
```

---

### 步驟 2：部署前端到 Vercel（約 10 分鐘）

#### 2.1 準備前端檔案

**已建置完成**：`frontend/dist/` 目錄包含所有建置檔案

#### 2.2 建立 Vercel 專案

1. **訪問 Vercel**：https://vercel.com
2. **登入**：使用 GitHub、GitLab 或 Email 帳號
3. **建立新專案**：
   - 點擊 "Add New..." → "Project"
   - 選擇 "**Upload**" 或 "**Deploy**" 選項

#### 2.3 上傳前端檔案

**方法 A：使用 Vercel CLI（推薦）**

```bash
# 1. 安裝 Vercel CLI
npm install -g vercel

# 2. 進入前端目錄
cd frontend

# 3. 登入
vercel login

# 4. 部署（會引導您設定）
vercel

# 5. 設定環境變數
vercel env add VITE_API_URL
# 輸入值：https://your-api.railway.app/api/v1
# 選擇環境：Production, Preview, Development

vercel env add VITE_USE_MOCK
# 輸入值：false
# 選擇環境：Production, Preview, Development

# 6. 生產環境部署
vercel --prod
```

**方法 B：使用 ZIP 上傳**

1. 壓縮 `frontend/dist/` 目錄的所有檔案成 ZIP
2. 在 Vercel 上傳 ZIP 檔案
3. Vercel 會自動解壓縮並部署

#### 2.4 設定環境變數

在 Vercel 專案設定 → Environment Variables 中添加：

```
VITE_API_URL=https://your-api.railway.app/api/v1
VITE_USE_MOCK=false
```

**重要**：將 `your-api.railway.app` 替換為步驟 1.5 中記下的 Railway 後端網域

#### 2.5 驗證前端部署

1. 訪問 Vercel 提供的 URL（例如：`your-app.vercel.app`）
2. 檢查頁面是否可以正常載入
3. 檢查瀏覽器 Console 是否有錯誤

---

### 步驟 3：更新 CORS 設定（約 2 分鐘）

#### 3.1 更新後端 CORS

1. 回到 Railway 後端專案設定
2. 更新 `CORS_ORIGINS` 環境變數：
   ```
   CORS_ORIGINS=["https://your-app.vercel.app"]
   ```
   **重要**：將 `your-app.vercel.app` 替換為實際的 Vercel 前端網域

3. 重新部署後端（如果需要）

---

### 步驟 4：測試部署（約 5 分鐘）

#### 4.1 測試後端

```bash
# 健康檢查
curl https://your-api.railway.app/health

# API 文檔
訪問：https://your-api.railway.app/docs

# 測試 API（如果未啟用認證）
curl https://your-api.railway.app/api/v1/topics?page=1&limit=1
```

#### 4.2 測試前端

1. 訪問前端 URL：`https://your-app.vercel.app`
2. 檢查功能：
   - ✅ 頁面可以正常載入
   - ✅ 可以連接後端 API
   - ✅ 主題列表可以顯示
   - ✅ 可以建立新主題
   - ✅ 圖片搜尋功能正常

#### 4.3 檢查整合

- ✅ 前端可以成功調用後端 API
- ✅ CORS 設定正確（沒有 CORS 錯誤）
- ✅ 所有功能正常運作

---

## 📋 部署檢查清單

### 部署前

- [x] 前端已建置（`frontend/dist/`）
- [x] 後端檔案已準備
- [ ] MongoDB Atlas 已建立並可連接
- [ ] 至少一個 AI 服務已配置
- [ ] 至少一個圖片搜尋服務已配置（或使用 DuckDuckGo）
- [ ] 已準備好 Railway 帳號
- [ ] 已準備好 Vercel 帳號

### 部署中

- [ ] 後端已部署到 Railway
- [ ] 後端環境變數已設定
- [ ] 後端公開網域已生成
- [ ] 前端已部署到 Vercel
- [ ] 前端環境變數已設定
- [ ] CORS 設定已更新

### 部署後

- [ ] 後端健康檢查正常
- [ ] 前端頁面可以正常載入
- [ ] 前端可以連接後端 API
- [ ] 所有功能正常運作
- [ ] HTTPS 已啟用

---

## 🔧 故障排除

### 問題 1：後端無法連接 MongoDB

**解決**：
- 檢查 `MONGODB_URL` 環境變數是否正確
- 檢查 MongoDB Atlas 的 IP 白名單設定
- 確認 MongoDB 用戶名和密碼正確

### 問題 2：前端無法連接後端（CORS 錯誤）

**解決**：
- 檢查後端 `CORS_ORIGINS` 環境變數
- 確保前端網域已添加到 CORS 允許列表
- 檢查前端 `VITE_API_URL` 是否正確

### 問題 3：API 請求返回 401 錯誤

**解決**：
- 如果啟用了 API Key 認證，檢查前端是否正確發送 `X-API-Key` header
- 確認後端 `API_KEY` 環境變數已設定
- 確認 API Key 值一致

### 問題 4：圖片搜尋失敗

**解決**：
- 檢查圖片搜尋服務的 API Key 是否正確
- 確認至少一個圖片搜尋服務已配置
- 如果所有服務都失敗，系統會自動使用 DuckDuckGo（不需要 API Key）

---

## 📝 部署後的重要資訊

### 後端網域
```
https://your-api.railway.app
```

### 前端網域
```
https://your-app.vercel.app
```

### API 端點
- 健康檢查：`https://your-api.railway.app/health`
- API 文檔：`https://your-api.railway.app/docs`
- API 基礎路徑：`https://your-api.railway.app/api/v1`

---

## 🎯 下一步

部署完成後：

1. **測試所有功能**
2. **設定自訂網域**（可選）
3. **設定監控和日誌**（可選）
4. **定期備份資料**

---

**最後更新**：2025-12-29  
**狀態**：✅ 準備就緒，可以開始部署

