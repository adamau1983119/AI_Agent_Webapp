# 生產環境問題診斷報告

> **日期**：2026-01-06  
> **問題**：Dashboard 無法自動生成內容和載入圖片，500 Internal Server Error

---

## 🔍 問題分析

### 1. 錯誤現象
- **前端控制台**：多個 `500 Internal Server Error`
- **錯誤訊息**：`{message: '伺服器內部錯誤', status: 500, code: 'INTERNAL_ERROR'}`
- **內容完成度**：0%
- **圖片完成度**：0%

### 2. 可能原因

#### A. DeepSeek API 配置問題
- **檢查點**：Railway 環境變數 `AI_SERVICE` 和 `DEEPSEEK_API_KEY`
- **代碼檢查**：`DeepSeekService.__init__()` 會檢查 API Key
- **錯誤處理**：如果 API Key 未設置，會拋出 `ValueError("DeepSeek API Key 未設定")`

#### B. 圖片搜尋服務配置問題
- **檢查點**：Railway 環境變數圖片服務 API Keys
- **備援機制**：應該有 DuckDuckGo 作為備援
- **錯誤處理**：如果所有 API Key 都未設置，應該使用 DuckDuckGo

#### C. 代碼修改未部署
- **檢查點**：Railway 是否部署了最新的代碼修改
- **關鍵修改**：
  1. `AutomationWorkflow` 動態獲取 AI 服務 ✅
  2. `contents.py` 統一使用 `AIServiceFactory` ✅
  3. 啟動時環境變數驗證日誌 ✅
  4. 圖片服務診斷端點 ✅

---

## 🔧 需要檢查的項目

### 1. Railway 環境變數配置

**必須設置的變數**：
```bash
AI_SERVICE=deepseek
DEEPSEEK_API_KEY=<your-api-key>
```

**圖片服務（至少設置一個）**：
```bash
GOOGLE_API_KEY=<your-api-key>
GOOGLE_SEARCH_ENGINE_ID=<your-engine-id>
# 或
UNSPLASH_ACCESS_KEY=<your-key>
# 或
PEXELS_API_KEY=<your-key>
# 或
PIXABAY_API_KEY=<your-key>
```

### 2. Railway 部署狀態

**檢查項目**：
- [ ] 最新代碼是否已提交到 Git
- [ ] Railway 是否已部署最新代碼
- [ ] Railway Logs 中是否有環境變數驗證日誌
- [ ] Railway Logs 中是否有錯誤訊息

### 3. API 端點測試

**診斷端點**：
- `GET /api/v1/validate/images` - 檢查圖片服務配置
- `GET /health` - 檢查服務健康狀態
- Railway Logs - 檢查啟動時的環境變數驗證日誌

---

## 📋 診斷步驟

### 步驟 1：檢查 Railway Logs

查看 Railway 部署日誌，確認：
1. 啟動時是否有環境變數驗證日誌
2. 是否有 `✅ DEEPSEEK_API_KEY 存在` 或 `⚠️ DEEPSEEK_API_KEY 不存在`
3. 是否有錯誤堆疊追蹤

### 步驟 2：測試診斷端點

訪問 `https://<railway-url>/api/v1/validate/images`，確認：
- 返回的 `available_services` 列表
- 各服務的配置狀態

### 步驟 3：檢查實際 API 調用

查看 Railway Logs 中的實際錯誤：
- AI 服務調用時的錯誤訊息
- 圖片搜尋時的錯誤訊息
- 完整的錯誤堆疊追蹤

---

## ⚠️ 重要提醒

1. **不要只依賴本地測試**：本地環境和生產環境配置可能不同
2. **檢查 Railway 實際配置**：環境變數可能沒有正確設置
3. **查看實際錯誤日誌**：500 錯誤的具體原因在 Railway Logs 中
4. **確認代碼已部署**：修改的代碼必須提交並部署到 Railway

---

## 🚀 下一步行動

1. **立即檢查 Railway Logs**，找出實際錯誤原因
2. **驗證 Railway 環境變數**，確認 `AI_SERVICE=deepseek` 和 `DEEPSEEK_API_KEY` 已設置
3. **測試診斷端點**，確認圖片服務配置狀態
4. **根據實際錯誤修復問題**，而不是假設問題原因

---

**報告生成時間**：2026-01-06  
**狀態**：待檢查 Railway 實際配置和日誌

