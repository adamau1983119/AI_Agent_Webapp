# 圖片搜尋功能修復統一修改指南

**版本：** 1.0  
**創建日期：** 2026年1月7日  
**目的：** 確保所有後續修改與專家規劃保持一致，避免分支過多導致難以執行

---

## 📋 核心原則

### 1. 所有修改必須參考檢查清單
- ✅ 每次修改前，先查看 `圖片搜尋功能修復行動計劃檢查清單_專家建議版.md`
- ✅ 確認修改對應的任務編號
- ✅ 完成後更新檢查清單狀態

### 2. 設計理念統一
- **錯誤處理：** 使用 `ImageSearchError` 異常類，不要使用 `ValueError` 或 `Exception`
- **日誌記錄：** 所有日誌必須包含 `trace_id`（如果可用）
- **API 響應：** 所有錯誤情況返回 `ImageSearchResponse`，不要返回 `JSONResponse` 或 500 錯誤
- **服務驗證：** 可選服務使用延遲驗證，必需服務使用立即驗證

### 3. 代碼風格統一
- 使用 `getattr(settings, 'KEY', '')` 而不是直接訪問 `settings.KEY`
- 所有服務方法簽名必須支援 `trace_id` 參數（可選）
- 所有錯誤訊息必須包含足夠的診斷資訊

---

## 🎯 當前實現狀態

### ✅ 已完成（與規劃一致）

#### 階段 1：緊急修復
- ✅ **任務 1.5：** trace_id 追蹤機制
  - 實現位置：`backend/app/api/v1/images.py`
  - 狀態：完成，所有請求都有 trace_id

- ✅ **任務 1.6：** 分級錯誤模型
  - 實現位置：`backend/app/services/images/exceptions.py`
  - 狀態：完成，定義了所有錯誤類型

- ✅ **任務 1.7：** 詳細服務調用日誌
  - 實現位置：`backend/app/services/images/image_service_manager.py`
  - 狀態：完成，記錄所有嘗試和結果

- ✅ **任務 1.8：** 改進 Google Custom Search 服務
  - 實現位置：`backend/app/services/images/google_custom_search.py`
  - 狀態：完成，包含完整錯誤處理和日誌

- ✅ **任務 1.9：** 改進 API 響應格式
  - 實現位置：`backend/app/api/v1/images.py`, `backend/app/schemas/image.py`
  - 狀態：完成，包含 attempts、source、trace_id

- ✅ **任務 1.10：** 更新前端 ImageSource 類型定義
  - 實現位置：`frontend/src/types/index.ts`, `frontend/src/api/images.ts`
  - 狀態：完成，包含所有來源

- ✅ **任務 1.11：** 改進前端錯誤顯示
  - 實現位置：`frontend/src/components/features/ImageSearch.tsx`
  - 狀態：完成，包含診斷模式

### ⚠️ 設計決策記錄

#### Google Custom Search 初始化驗證
**決策：** 使用延遲驗證（在 `search_images` 中檢查），而不是立即驗證（在 `__init__` 中 raise）

**理由：**
1. Google Custom Search 是可選服務，有 DuckDuckGo 作為後備
2. 如果立即驗證，配置缺失會導致 `ImageServiceManager` 初始化失敗
3. 延遲驗證允許服務被創建，但在使用時才檢查配置
4. 錯誤會在 `attempts` 中記錄，不會阻止其他服務運行

**實現位置：**
- `backend/app/services/images/google_custom_search.py` 第 19-28 行（初始化）
- `backend/app/services/images/google_custom_search.py` 第 52-58 行（使用時驗證）

**與專家建議的差異：**
- 專家建議在 `__init__` 中驗證並 raise 異常
- 我們的實現選擇延遲驗證，因為它是可選服務
- **這個差異是可接受的**，因為它符合當前架構設計

---

## 📝 後續修改流程

### 步驟 1：確認修改範圍
1. 查看檢查清單，確認對應的任務
2. 檢查當前實現狀態
3. 確認是否需要修改

### 步驟 2：設計修改方案
1. 參考檢查清單中的實施內容
2. 確保符合核心原則
3. 記錄設計決策（如果有差異）

### 步驟 3：實施修改
1. 按照統一的代碼風格
2. 確保錯誤處理一致
3. 添加必要的日誌和 trace_id

### 步驟 4：驗證修改
1. 檢查 lint 錯誤
2. 確認符合檢查清單要求
3. 更新檢查清單狀態

### 步驟 5：提交修改
1. 提交訊息必須包含任務編號
2. 說明修改內容和理由
3. 如果有設計決策差異，必須說明

---

## 🔍 待完成任務

### 階段 1：緊急修復（部分完成）

#### ⏳ 任務 1.1：測試 Google Custom Search API
- **狀態：** 待執行
- **要求：** 使用測試腳本驗證 API 配置
- **優先級：** 高（診斷問題）

#### ⏳ 任務 1.2：檢查後端日誌完整性
- **狀態：** 待執行
- **要求：** 驗證 trace_id 和服務調用記錄
- **優先級：** 高（驗證修復）

#### ⏳ 任務 1.4：建立專用 Google Image CSE
- **狀態：** 待執行
- **要求：** 創建圖片專用搜尋引擎
- **優先級：** 高（專家建議提前到階段1）

#### ⏳ 任務 1.12：實現臨時橋接層
- **狀態：** 待執行
- **要求：** 統一 ImageService 和 ImageServiceManager
- **優先級：** 中（避免不一致）

---

## 🚫 禁止事項

### 1. 不要偏離檢查清單
- ❌ 不要添加檢查清單中沒有的功能
- ❌ 不要跳過檢查清單中的任務
- ❌ 不要改變已完成的任務實現方式

### 2. 不要破壞一致性
- ❌ 不要使用不同的錯誤處理方式
- ❌ 不要使用不同的日誌格式
- ❌ 不要使用不同的 API 響應格式

### 3. 不要忽略設計決策
- ❌ 不要改變已記錄的設計決策（除非有充分理由）
- ❌ 不要添加與當前架構衝突的功能
- ❌ 不要移除已實現的功能

---

## 📚 參考文檔

### 主要文檔
1. **檢查清單：** `圖片搜尋功能修復行動計劃檢查清單_專家建議版.md`
2. **長遠計劃：** `圖片搜尋功能長遠修復行動計劃_第三方專家審查.md`
3. **問題診斷：** `圖片搜尋功能問題診斷報告_第三方專家審查.md`

### 關鍵代碼文件
1. **錯誤模型：** `backend/app/services/images/exceptions.py`
2. **服務管理器：** `backend/app/services/images/image_service_manager.py`
3. **Google 服務：** `backend/app/services/images/google_custom_search.py`
4. **API 端點：** `backend/app/api/v1/images.py`
5. **前端組件：** `frontend/src/components/features/ImageSearch.tsx`

---

## 🔄 更新記錄

### 2026-01-07
- 創建統一修改指南
- 記錄當前實現狀態
- 記錄設計決策（Google Custom Search 延遲驗證）
- 列出待完成任務

---

## ✅ 檢查清單（每次修改前檢查）

- [ ] 已查看檢查清單，確認對應任務
- [ ] 已確認當前實現狀態
- [ ] 已確認符合核心原則
- [ ] 已確認符合代碼風格
- [ ] 已記錄設計決策（如有差異）
- [ ] 已添加必要的日誌和 trace_id
- [ ] 已檢查 lint 錯誤
- [ ] 已更新檢查清單狀態
- [ ] 提交訊息包含任務編號

---

**重要提醒：** 所有修改必須遵循此指南，確保與規劃保持一致！

