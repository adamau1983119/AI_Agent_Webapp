# 圖片搜尋功能修復行動計劃檢查清單（專家建議版）

**版本：** 2.0（根據第三方專家建議調整）  
**更新日期：** 2026年1月7日  
**調整說明：** 根據專家建議調整優先順序，提前關鍵任務，簡化複雜度

---

## 📋 階段 1：緊急診斷與修復（第1週）

### 🔍 診斷階段（1-2天）

#### ✅ 任務 1.1：測試 Google Custom Search API
- [ ] 使用 `test_google_cse.sh` 測試多個查詢詞（cat, dog, sunset, technology）
- [ ] 確認 HTTP 狀態碼均為 200
- [ ] 至少 80% 查詢返回 items > 0
- [ ] 記錄完整的測試結果（狀態碼、items 數量、錯誤訊息）
- [ ] 生成 Google API 測試報告
- [ ] **如果測試失敗 → 立即檢查 Google API 配置和配額**

**負責人：** 後端開發人員  
**交付物：** Google API 測試報告

---

#### ✅ 任務 1.2：檢查後端日誌完整性
- [ ] 在前端發起圖片搜尋請求
- [ ] 檢查 Railway 日誌中是否有 Google Custom Search 調用記錄
- [ ] 檢查是否有 DuckDuckGo 調用記錄
- [ ] 確認每個請求是否有 trace_id
- [ ] 確認日誌是否記錄每個服務的嘗試順序
- [ ] 確認日誌是否包含成功/失敗/空結果資訊
- [ ] 生成日誌分析報告

**負責人：** 後端開發人員  
**交付物：** 日誌分析報告

---

#### ✅ 任務 1.3：檢查前端 source 類型定義
- [ ] 檢查 `frontend/src/types/index.ts` 中的 `ImageSource` 類型定義
- [ ] 確認是否包含所有後端支援的來源（Unsplash、Pexels、Pixabay、Google、DuckDuckGo）
- [ ] 檢查 `frontend/src/components/features/ImageSearch.tsx` 中的來源選項
- [ ] 確認下拉選單是否顯示所有可用來源
- [ ] 確認「所有來源」選項是否正確傳遞 `undefined` 給後端
- [ ] 生成前端代碼審查報告

**負責人：** 前端開發人員  
**交付物：** 前端代碼審查報告

---

### ⚡ 緊急修復階段（2-3天）

#### ✅ 任務 1.4：建立專用 Google Image CSE（**專家建議：提前到階段1**）
- [ ] 前往 Google Custom Search Console
- [ ] 建立新的搜尋引擎（專門用於圖片搜尋）
- [ ] 設定為「搜尋整個網路」
- [ ] **啟用「圖片搜尋」功能**（關鍵）
- [ ] 取得新的 Search Engine ID
- [ ] 使用測試腳本驗證新 CSE 能返回圖片結果
- [ ] 更新 Railway 環境變數 `GOOGLE_SEARCH_ENGINE_ID`
- [ ] 測試確認新 CSE 正常工作
- [ ] **如果新 CSE 測試成功 → 立即切換使用，避免通用引擎問題**

**負責人：** DevOps 工程師  
**交付物：** 新的 Search Engine ID、CSE 配置文檔、測試報告

**專家建議理由：** 避免浪費時間在通用引擎的 bug 上，提前驗證專用 CSE 的穩定性

---

#### ✅ 任務 1.5：實現 trace_id 追蹤機制
- [ ] 在 `backend/app/api/v1/images.py` 入口為每個請求生成唯一 trace_id
- [ ] 將 trace_id 傳遞到所有服務層
- [ ] 確保所有日誌都包含 trace_id
- [ ] 前端錯誤訊息顯示 trace_id
- [ ] 測試確認 trace_id 正確追蹤

**負責人：** 後端開發人員  
**交付物：** 更新的 API 端點代碼

---

#### ✅ 任務 1.6：實現分級錯誤模型
- [ ] 定義 `ImageSearchError` 異常類
- [ ] 定義錯誤類型：
  - [ ] `SOURCE_UNAVAILABLE` - 服務不可用（API Key 未設定）
  - [ ] `RATE_LIMIT` - API 配額用盡
  - [ ] `INVALID_CONFIG` - 配置錯誤
  - [ ] `NO_RESULTS` - 查詢無結果（正常情況）
  - [ ] `UPSTREAM_ERROR` - 上游服務錯誤（5xx）
  - [ ] `HTTP_ERROR` - HTTP 錯誤（非 2xx）
- [ ] 錯誤訊息包含來源與診斷資訊
- [ ] 前端能根據錯誤類型顯示不同提示
- [ ] 測試確認錯誤處理正確

**負責人：** 後端開發人員  
**交付物：** 錯誤處理模組和更新的服務代碼

---

#### ✅ 任務 1.7：添加詳細服務調用日誌
- [ ] 在 `ImageServiceManager.search()` 中記錄每個服務的嘗試
- [ ] 記錄成功/失敗/空結果的詳細資訊
- [ ] 響應包含 `attempts[]` 陣列
- [ ] 返回最終使用的來源
- [ ] 測試確認日誌完整記錄

**負責人：** 後端開發人員  
**交付物：** 更新的服務管理器代碼

---

#### ✅ 任務 1.8：改進 Google Custom Search 服務
- [ ] 初始化時驗證 API Key 與 Search Engine ID
- [ ] 記錄請求日誌（隱藏敏感資訊，顯示查詢參數與狀態碼）
- [ ] 記錄響應日誌（顯示 `totalResults` 與 `items` 數量）
- [ ] 過濾非圖片結果（只保留 `mime` 為 `image/` 的結果）
- [ ] 完整錯誤處理：
  - [ ] 429 → RATE_LIMIT
  - [ ] 403 → INVALID_CONFIG_OR_PERMISSION
  - [ ] 5xx → UPSTREAM_ERROR
  - [ ] Timeout → UPSTREAM_ERROR
- [ ] 測試確認所有錯誤情況正確處理

**負責人：** 後端開發人員  
**交付物：** 更新的 Google Custom Search 服務代碼

---

#### ✅ 任務 1.9：改進 API 響應格式
- [ ] 響應包含 `attempts[]` 陣列
- [ ] 響應包含 `source`（最終使用的來源）
- [ ] 響應包含 `trace_id`
- [ ] 錯誤情況返回 200（除非不可恢復的異常）
- [ ] 更新 `ImageSearchResponse` Schema
- [ ] 測試確認響應格式正確

**負責人：** 後端開發人員  
**交付物：** 更新的 API 端點代碼和 Schema

---

#### ✅ 任務 1.10：更新前端 ImageSource 類型定義
- [ ] 在 `frontend/src/types/index.ts` 添加 `'google_custom_search'` 和 `'duckduckgo'`
- [ ] 更新 `ImageSearch.tsx` 中的來源選項
- [ ] 下拉選單顯示所有來源（包括 Google 和 DuckDuckGo）
- [ ] 「所有來源」選項正確傳遞 `undefined`
- [ ] 測試確認類型定義正確

**負責人：** 前端開發人員  
**交付物：** 更新的類型定義和 UI 組件

---

#### ✅ 任務 1.11：改進前端錯誤顯示
- [ ] 顯示 `attempts` 記錄（每個來源的嘗試結果）
- [ ] 區分不同錯誤類型（顯示不同的提示訊息）
- [ ] 顯示 `trace_id`（便於追蹤問題）
- [ ] 提供用戶友好的錯誤提示
- [ ] **實現「診斷模式」開關**（**專家建議：新增**）
  - [ ] 開發/測試人員可以看到完整錯誤細節
  - [ ] 普通用戶只看到簡化提示
  - [ ] 診斷模式顯示 attempts、trace_id、錯誤堆疊等
- [ ] 測試確認錯誤顯示正確

**負責人：** 前端開發人員  
**交付物：** 更新的 UI 組件

**專家建議理由：** 提升可觀測性，讓開發人員能快速診斷問題，同時不影響普通用戶體驗

---

#### ✅ 任務 1.12：實現臨時橋接層（**專家建議：新增**）
- [ ] 設計臨時橋接層，讓 `ImageService` 和 `ImageServiceManager` 共用同一 provider 列表
- [ ] 確保兩個服務類使用相同的優先順序
- [ ] 確保兩個服務類使用相同的錯誤處理邏輯
- [ ] 測試確認「智能匹配」和「手動搜尋」行為一致
- [ ] 記錄橋接層實現，為後續統一做準備

**負責人：** 後端開發人員  
**交付物：** 臨時橋接層代碼和測試報告

**專家建議理由：** 避免短期內繼續出現不一致，為後續統一架構做準備

---

### ✅ 驗證階段（1天）

#### ✅ 任務 1.13：端到端測試
- [ ] **測試 1：手動搜尋 - 所有來源**
  - [ ] 選擇「所有來源」，輸入關鍵字，點擊搜尋
  - [ ] 確認返回圖片結果
  - [ ] 確認日誌顯示嘗試了所有服務
  - [ ] 確認前端顯示 attempts 資訊
- [ ] **測試 2：手動搜尋 - Google Custom Search**
  - [ ] 選擇「Google」，輸入關鍵字，點擊搜尋
  - [ ] 確認返回 Google 圖片結果
  - [ ] 確認後端日誌記錄 Google API 調用
- [ ] **測試 3：手動搜尋 - DuckDuckGo**
  - [ ] 選擇「DuckDuckGo」，輸入關鍵字，點擊搜尋
  - [ ] 確認返回 DuckDuckGo 圖片結果
- [ ] **測試 4：智能匹配照片**
  - [ ] 點擊「智能匹配照片」
  - [ ] 確認根據文章內容自動匹配圖片
  - [ ] 確認圖片添加成功
  - [ ] **確認與手動搜尋使用相同的服務邏輯**（橋接層驗證）
- [ ] **測試 5：錯誤情況處理**
  - [ ] 使用無效的 API Key 測試
  - [ ] 確認顯示詳細的錯誤訊息
  - [ ] 確認包含 attempts 資訊
  - [ ] 確認診斷模式顯示完整錯誤
- [ ] **測試 6：專用 CSE 驗證**
  - [ ] 確認使用新的專用 Google Image CSE
  - [ ] 確認返回圖片結果穩定
  - [ ] 對比通用 CSE 和專用 CSE 的結果差異

**驗證標準：**
- [ ] 所有測試用例通過
- [ ] 後端日誌完整記錄所有嘗試
- [ ] 前端正確顯示結果和錯誤資訊
- [ ] 沒有 500 錯誤（除非不可恢復的異常）
- [ ] 專用 CSE 測試成功

**負責人：** QA 測試人員  
**交付物：** 測試報告

---

## 📋 階段 2：架構統一與優化（第2週）

### 🏗️ 架構統一階段

#### ✅ 任務 2.1：設計統一的圖片服務介面
- [ ] 定義 `ImageProvider` 抽象基類
- [ ] 定義介面方法：
  - [ ] `name` - 服務名稱
  - [ ] `requires_api_key` - 是否需要 API Key
  - [ ] `search_images()` - 搜尋圖片
  - [ ] `is_available()` - 檢查服務是否可用
- [ ] 所有服務實現統一介面
- [ ] 介面定義清晰明確，易於擴展
- [ ] 測試確認介面設計合理

**負責人：** 後端架構師  
**交付物：** 統一的服務介面定義

---

#### ✅ 任務 2.2：統一服務管理器
- [ ] 合併 `ImageService` 和 `ImageServiceManager` 為一個服務類
- [ ] 實現統一的 `ImageService` 類
- [ ] 支援健康狀態追蹤（基礎版本）
- [ ] 支援自動故障轉移
- [ ] 保持向後兼容
- [ ] 移除臨時橋接層（如果已實現）
- [ ] 測試確認統一後功能正常

**負責人：** 後端開發人員  
**交付物：** 統一的圖片服務管理器

---

#### ✅ 任務 2.3：實現健康檢查基礎版本（**專家建議：提前到階段2**）
- [ ] 實現簡單的健康狀態追蹤
- [ ] **使用「最近 5 分鐘失敗率」判斷**（專家建議：簡化）
- [ ] 記錄每個服務的成功/失敗次數
- [ ] 根據健康狀態排序 provider（健康的優先）
- [ ] 自動降級不健康的服務
- [ ] 測試確認健康檢查正常工作

**負責人：** 後端開發人員  
**交付物：** 健康檢查基礎版本

**專家建議理由：** 避免過度複雜化，先用簡單的失敗率判斷，後續再逐步優化

---

#### ✅ 任務 2.4：更新所有使用點
- [ ] 更新 `backend/app/api/v1/images.py` - API 端點
- [ ] 更新 `backend/app/services/automation/workflow.py` - 工作流
- [ ] 更新 `backend/app/services/images/enhanced_photo_matcher.py` - 圖片匹配器
- [ ] 檢查其他使用圖片服務的地方
- [ ] 確認所有使用點都更新為統一的服務類
- [ ] 測試確認所有功能正常運作

**負責人：** 後端開發人員  
**交付物：** 更新的代碼和測試報告

---

#### ✅ 任務 2.5：實現 CSE 配置驗證
- [ ] 實現 `validate_google_cse_config()` 函數
- [ ] 應用啟動時驗證 CSE 配置
- [ ] 驗證失敗時記錄詳細錯誤
- [ ] 提供配置建議
- [ ] 測試確認配置驗證正常工作

**負責人：** 後端開發人員  
**交付物：** CSE 配置驗證模組

---

## 📋 階段 3：健康檢查完善與自動降級（第3週）

### 🔧 健康檢查完善

#### ✅ 任務 3.1：完善健康檢查機制
- [ ] 在基礎版本上逐步完善
- [ ] 實現更詳細的健康指標：
  - [ ] 成功率
  - [ ] 平均響應時間
  - [ ] 錯誤碼分布
- [ ] 實現健康狀態快取（避免頻繁檢查）
- [ ] 實現健康狀態過期機制
- [ ] 測試確認完善後的健康檢查正常工作

**負責人：** 後端開發人員  
**交付物：** 完善的健康檢查機制

**專家建議：** 在基礎版本上逐步完善，不要一開始就過度複雜化

---

#### ✅ 任務 3.2：實現自動降級策略
- [ ] 定義降級規則（例如：連續失敗 3 次自動降級）
- [ ] 實現降級時間窗口（例如：5 分鐘內不重試）
- [ ] 實現自動恢復機制（例如：健康後自動恢復）
- [ ] 記錄降級和恢復事件
- [ ] 測試確認自動降級正常工作

**負責人：** 後端開發人員  
**交付物：** 自動降級機制

---

## 📋 階段 4：監控與維護（第4-6週）

### 📊 監控與指標（第4週）

#### ✅ 任務 4.1：實現服務使用指標追蹤
- [ ] 實現 `ImageServiceMetrics` 類
- [ ] 追蹤關鍵指標：
  - [ ] 請求次數
  - [ ] 成功次數
  - [ ] 失敗次數
  - [ ] 平均延遲時間
  - [ ] 錯誤碼分布
- [ ] 提供指標查詢 API
- [ ] 指標數據持久化（可選）
- [ ] 測試確認指標追蹤正常工作

**負責人：** 後端開發人員  
**交付物：** 指標追蹤模組和 API

---

#### ✅ 任務 4.2：實現告警機制
- [ ] 定義告警規則：
  - [ ] 服務連續失敗超過閾值
  - [ ] API 配額用盡
  - [ ] 所有服務都不可用
- [ ] 實現告警通知（Email、Slack、等）
- [ ] 實現告警抑制（避免重複告警）
- [ ] 測試確認告警機制正常工作

**負責人：** DevOps 工程師  
**交付物：** 告警配置和測試報告

---

### ⚡ 性能優化（第5週）

#### ✅ 任務 4.3：實現結果快取
- [ ] 實現 `ImageSearchCache` 類
- [ ] 快取常見查詢的結果
- [ ] 實現 TTL 機制（例如：1 小時）
- [ ] 實現快取失效機制
- [ ] 測試確認快取機制正常工作
- [ ] 測量性能提升（減少 API 調用次數）

**負責人：** 後端開發人員  
**交付物：** 快取模組和性能測試報告

---

#### ✅ 任務 4.4：實現並發請求優化
- [ ] 使用 `asyncio.gather()` 並發請求多個服務
- [ ] 選擇最快返回有效結果的服務
- [ ] 取消其他未完成的請求
- [ ] 測試確認並發請求正常工作
- [ ] 測量性能提升（減少總體響應時間）

**負責人：** 後端開發人員  
**交付物：** 並發請求實現和性能測試報告

---

### 📚 文檔與測試（第6週）

#### ✅ 任務 4.5：完善 API 文檔
- [ ] 更新 OpenAPI/Swagger 文檔
- [ ] 添加請求/響應範例
- [ ] 添加錯誤碼說明
- [ ] 添加最佳實踐指南
- [ ] 添加故障排除指南
- [ ] 測試確認文檔完整準確

**負責人：** 技術文檔工程師  
**交付物：** 完整的 API 文檔

---

#### ✅ 任務 4.6：完善測試套件
- [ ] 為所有圖片服務添加單元測試
- [ ] 添加整合測試
- [ ] 添加端到端測試
- [ ] 實現測試覆蓋率目標（>80%）
- [ ] 測試包含邊界情況
- [ ] 所有測試通過

**負責人：** QA 測試人員  
**交付物：** 測試套件和測試報告

---

## 📋 階段 5：持續監控與維護（長期）

### 🔄 定期審查（每月）

#### ✅ 任務 5.1：服務健康狀況審查
- [ ] 審查服務成功率
- [ ] 審查平均響應時間
- [ ] 審查錯誤分布
- [ ] 審查 API 配額使用情況
- [ ] 生成月度健康報告

**負責人：** DevOps 工程師  
**頻率：** 每月

---

#### ✅ 任務 5.2：代碼質量審查
- [ ] 代碼審查
- [ ] 技術債務評估
- [ ] 性能優化機會識別
- [ ] 生成季度代碼質量報告

**負責人：** 技術負責人  
**頻率：** 每季度

---

### 🚀 持續改進（持續）

#### ✅ 任務 5.3：添加新的圖片服務
- [ ] 評估新服務的需求和可行性
- [ ] 實現統一的服務介面
- [ ] 添加配置和文檔
- [ ] 測試和部署

**負責人：** 後端開發人員  
**觸發條件：** 業務需求

---

#### ✅ 任務 5.4：優化現有服務
- [ ] 減少 API 調用次數
- [ ] 提高響應速度
- [ ] 改善錯誤處理
- [ ] 優化資源使用

**負責人：** 後端開發人員  
**頻率：** 持續

---

## 📊 進度追蹤

### 階段 1 進度
- [ ] 診斷階段完成
- [ ] 緊急修復階段完成
- [ ] 驗證階段完成
- [ ] **階段 1 總體完成**

### 階段 2 進度
- [ ] 架構統一完成
- [ ] 健康檢查基礎版本完成
- [ ] CSE 配置驗證完成
- [ ] **階段 2 總體完成**

### 階段 3 進度
- [ ] 健康檢查完善完成
- [ ] 自動降級策略完成
- [ ] **階段 3 總體完成**

### 階段 4 進度
- [ ] 監控與指標完成
- [ ] 性能優化完成
- [ ] 文檔與測試完成
- [ ] **階段 4 總體完成**

---

## 🎯 關鍵里程碑

- [ ] **里程碑 1：** 專用 Google Image CSE 建立並測試成功（第1週）
- [ ] **里程碑 2：** 圖片搜尋功能恢復正常（第1週結束）
- [ ] **里程碑 3：** 服務類統一完成（第2週結束）
- [ ] **里程碑 4：** 健康檢查機制運行正常（第3週結束）
- [ ] **里程碑 5：** 監控系統上線（第4週結束）
- [ ] **里程碑 6：** 所有優化和文檔完成（第6週結束）

---

## 📝 備註

### 專家建議的關鍵調整
1. ✅ **Google CSE 專用引擎提前到階段1** - 避免浪費時間在通用引擎問題上
2. ✅ **臨時橋接層在階段1實現** - 避免短期不一致
3. ✅ **健康檢查基礎版本提前到階段2** - 簡化複雜度，更快見效
4. ✅ **診斷模式開關** - 提升可觀測性

### 風險提醒
- ⚠️ Google API 配額限制：需要監控配額使用情況
- ⚠️ 服務類統一可能影響現有功能：需要充分測試
- ⚠️ 健康檢查複雜度：先用簡單版本，逐步完善

---

**檢查清單版本：** 2.0（專家建議版）  
**最後更新：** 2026年1月7日

