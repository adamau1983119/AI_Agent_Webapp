# 圖片搜尋功能問題診斷報告

**報告日期：** 2026年1月7日  
**問題持續時間：** 約1週  
**問題嚴重性：** 高（核心功能無法使用）  
**報告目的：** 請求第三方專家審查並提供改善建議

---

## 1. 問題概述

### 1.1 問題描述
AI Agent Webapp 的圖片搜尋功能無法正常工作。用戶在前端點擊「智能匹配照片」或「手動搜尋」時，無法獲取任何圖片結果，顯示「沒有找到圖片」。

### 1.2 影響範圍
- **功能影響：** 圖片搜尋功能完全無法使用
- **用戶體驗：** 所有主題都無法添加圖片，內容完成度顯示為 0%
- **業務影響：** 核心功能缺失，影響應用完整性

### 1.3 問題表現
- 前端顯示「沒有找到圖片」
- 瀏覽器控制台出現 500 Internal Server Error
- 後端日誌顯示圖片服務調用失敗
- 即使配置了 Google Custom Search API，仍然無法搜尋圖片

---

## 2. 技術架構

### 2.1 系統架構
- **前端：** React + TypeScript + Vite，部署於 Vercel
- **後端：** FastAPI + Python，部署於 Railway
- **資料庫：** MongoDB Atlas
- **圖片服務：** 多服務備援機制

### 2.2 圖片服務架構
```
前端 ImageSearch 組件
    ↓
API 端點: /api/v1/images/search
    ↓
ImageServiceManager (後端)
    ↓
服務優先順序：
1. Unsplash (需要 API Key)
2. Pexels (需要 API Key)
3. Pixabay (需要 API Key)
4. Google Custom Search (需要 API Key + Search Engine ID)
5. DuckDuckGo (不需要 API Key，後備服務)
```

### 2.3 當前配置狀態
- ✅ **Google Custom Search API：** 已配置
  - GOOGLE_API_KEY: 已設定
  - GOOGLE_SEARCH_ENGINE_ID: 已設定 (e1dae0813e62d416d)
- ❌ **Unsplash API：** 未配置
- ❌ **Pexels API：** 未配置
- ❌ **Pixabay API：** 未配置
- ✅ **DuckDuckGo：** 自動可用（不需要 API Key）

---

## 3. 已嘗試的解決方案

### 3.1 後端修復
1. **修復 AttributeError**
   - 問題：`Settings` 物件缺少 `DEEPSEEK_API_KEY` 等屬性
   - 解決：使用 `getattr()` 安全訪問屬性
   - 結果：✅ 解決了啟動錯誤

2. **添加 DuckDuckGo 後備服務**
   - 問題：所有 API Key 未設定時，圖片搜尋失敗
   - 解決：在 `ImageService` 和 `ImageServiceManager` 中添加 DuckDuckGo 作為後備
   - 結果：✅ 代碼已更新，但功能仍無法使用

3. **改進錯誤處理**
   - 問題：API 返回 500 錯誤導致前端崩潰
   - 解決：改進錯誤處理，返回空列表而不是拋出異常
   - 結果：✅ 減少了 500 錯誤，但仍無法獲取圖片

4. **更新環境變數驗證**
   - 問題：驗證器未識別 Google Custom Search
   - 解決：更新驗證邏輯，正確識別 Google Custom Search
   - 結果：✅ 日誌顯示正確，但功能仍無法使用

### 3.2 前端問題發現
- **問題：** 前端圖片搜尋下拉選單缺少 Google Custom Search 選項
- **發現：** 前端只顯示 Unsplash、Pexels、Pixabay，沒有 Google Custom Search
- **影響：** 用戶無法直接選擇 Google Custom Search，可能導致「所有來源」選項無法正確使用 Google 服務

---

## 4. 錯誤日誌分析

### 4.1 後端日誌（成功啟動）
```
2026-01-07 07:14:56 | INFO | 已配置的圖片服務: Google Custom Search
2026-01-07 07:14:56 | INFO | 圖片搜尋服務：Google Custom Search 已配置，DuckDuckGo 作為後備服務
2026-01-07 07:14:56 | INFO | ✅ GOOGLE_API_KEY 存在
2026-01-07 07:14:56 | INFO | ✅ GOOGLE_SEARCH_ENGINE_ID 存在
```

### 4.2 前端錯誤（瀏覽器控制台）
```
GET https://gentle-enchantment-production-1865.up.railway.app/api/v1/images/search?... 
500 (Internal Server Error)

API Error: {
  message: '伺服器內部錯誤',
  status: 500,
  code: 'INTERNAL_ERROR'
}
```

### 4.3 問題點
- 後端顯示配置正確，但 API 調用時返回 500 錯誤
- 沒有看到 Google Custom Search API 調用的日誌
- 沒有看到 DuckDuckGo 後備服務的調用日誌

---

## 5. 代碼結構分析

### 5.1 後端關鍵文件
```
backend/app/api/v1/images.py          # 圖片搜尋 API 端點
backend/app/services/images/
  ├── image_service_manager.py       # 圖片服務管理器（使用 ImageServiceManager）
  ├── image_service.py               # 圖片服務（使用 ImageService）
  ├── google_custom_search.py        # Google Custom Search 服務
  └── duckduckgo.py                  # DuckDuckGo 服務
```

### 5.2 前端關鍵文件
```
frontend/src/components/features/ImageSearch.tsx  # 圖片搜尋組件
frontend/src/api/images.ts                        # 圖片 API 客戶端
frontend/src/types/index.ts                       # 類型定義
```

### 5.3 潛在問題點

#### 問題 1：兩個圖片服務類
- `ImageService` - 用於 workflow 自動生成
- `ImageServiceManager` - 用於 API 端點
- **問題：** 兩個服務類可能有不同的行為，導致不一致

#### 問題 2：前端來源選項不完整
- 前端只顯示：Unsplash、Pexels、Pixabay
- 缺少：Google Custom Search、DuckDuckGo
- **問題：** 用戶選擇「所有來源」時，前端可能只嘗試前三個服務

#### 問題 3：API 端點使用的服務
- `/api/v1/images/search` 使用 `ImageServiceManager`
- `/api/v1/images/{topic_id}/match` 使用 `EnhancedPhotoMatcher` → `ImageService`
- **問題：** 兩個端點使用不同的服務類，可能導致行為不一致

---

## 6. 具體問題點

### 6.1 後端問題
1. **Google Custom Search API 調用失敗**
   - 可能原因：
     - API Key 或 Search Engine ID 配置錯誤
     - API 配額已用完
     - 網路請求失敗
     - 參數格式錯誤

2. **錯誤處理過於寬鬆**
   - 當前：所有錯誤都返回空列表
   - 問題：無法區分「沒有結果」和「服務失敗」
   - 影響：無法診斷具體問題

3. **日誌記錄不足**
   - 缺少詳細的 API 調用日誌
   - 缺少錯誤堆疊追蹤
   - 無法追蹤請求流程

### 6.2 前端問題
1. **來源選項不完整**
   - 缺少 Google Custom Search 選項
   - 缺少 DuckDuckGo 選項
   - 「所有來源」邏輯可能不完整

2. **錯誤處理不當**
   - 500 錯誤沒有詳細錯誤訊息
   - 用戶無法知道具體失敗原因
   - 沒有重試機制

3. **類型定義可能過時**
   - `ImageSource` 類型可能不包含所有後端支援的來源
   - 可能導致類型不匹配

---

## 7. 測試場景

### 7.1 測試用例 1：手動搜尋圖片
- **操作：** 用戶在前端選擇關鍵字，點擊「搜尋」
- **預期：** 返回圖片列表
- **實際：** 返回 500 錯誤或空列表
- **狀態：** ❌ 失敗

### 7.2 測試用例 2：智能匹配照片
- **操作：** 用戶點擊「智能匹配照片 (8張)」
- **預期：** 根據文章內容自動匹配並添加圖片
- **實際：** 返回 500 錯誤或沒有圖片
- **狀態：** ❌ 失敗

### 7.3 測試用例 3：直接調用 Google Custom Search API
- **操作：** 使用 Postman 或 curl 直接調用後端 API
- **預期：** 返回圖片列表
- **實際：** 未測試
- **狀態：** ⚠️ 待測試

---

## 8. 環境配置

### 8.1 Railway 環境變數
```
DEEPSEEK_API_KEY=✅ 已設定
GOOGLE_API_KEY=✅ 已設定
GOOGLE_SEARCH_ENGINE_ID=✅ 已設定 (e1dae0813e62d416d)
UNSPLASH_ACCESS_KEY=❌ 未設定
PEXELS_API_KEY=❌ 未設定
PIXABAY_API_KEY=❌ 未設定
```

### 8.2 後端版本
- Python: 3.11.14
- FastAPI: >=0.115.0
- pydantic: >=2.10.0
- pydantic-settings: >=2.6.0

### 8.3 前端版本
- React: (需確認)
- TypeScript: (需確認)
- Vite: (需確認)

---

## 9. 請求專家審查的問題

### 9.1 架構設計問題
1. **為什麼需要兩個圖片服務類？**
   - `ImageService` vs `ImageServiceManager`
   - 是否應該統一為一個服務類？
   - 兩個服務類的差異是否必要？

2. **備援機制是否正確實現？**
   - 當所有 API Key 服務失敗時，是否正確切換到 DuckDuckGo？
   - 錯誤處理邏輯是否正確？
   - 日誌記錄是否足夠？

### 9.2 實現問題
1. **Google Custom Search API 調用是否正確？**
   - API Key 和 Search Engine ID 的使用是否正確？
   - 請求參數格式是否正確？
   - 錯誤處理是否適當？

2. **前端後端同步問題**
   - 為什麼前端來源選項與後端不一致？
   - 「所有來源」選項的實現邏輯是否正確？
   - 類型定義是否完整？

### 9.3 診斷問題
1. **如何有效診斷問題？**
   - 應該添加哪些日誌？
   - 如何區分「沒有結果」和「服務失敗」？
   - 如何追蹤完整的請求流程？

2. **錯誤處理策略**
   - 當前返回空列表的策略是否正確？
   - 是否應該返回更詳細的錯誤訊息？
   - 前端應該如何處理不同的錯誤情況？

---

## 10. 建議的改善方向

### 10.1 短期改善（快速修復）
1. **添加詳細日誌**
   - 記錄每個圖片服務的調用
   - 記錄 API 響應和錯誤
   - 記錄完整的請求流程

2. **修復前端來源選項**
   - 添加 Google Custom Search 選項
   - 更新類型定義
   - 確保「所有來源」包含所有服務

3. **改進錯誤訊息**
   - 返回更詳細的錯誤訊息
   - 區分不同類型的錯誤
   - 提供診斷資訊

### 10.2 中期改善（架構優化）
1. **統一圖片服務類**
   - 考慮合併 `ImageService` 和 `ImageServiceManager`
   - 或明確區分使用場景
   - 確保行為一致

2. **改進備援機制**
   - 實現更智能的服務選擇
   - 添加服務健康檢查
   - 實現自動故障轉移

3. **完善測試**
   - 添加單元測試
   - 添加整合測試
   - 添加端到端測試

### 10.3 長期改善（架構重構）
1. **服務發現機制**
   - 動態發現可用的圖片服務
   - 根據配置自動啟用/禁用服務
   - 前端動態顯示可用服務

2. **監控和告警**
   - 添加服務監控
   - 實現錯誤告警
   - 追蹤服務使用情況

3. **文檔完善**
   - 完善 API 文檔
   - 添加架構文檔
   - 添加故障排除指南

---

## 11. 關鍵問題總結

### 11.1 核心問題
**圖片搜尋功能完全無法使用，即使配置了 Google Custom Search API，仍然無法獲取圖片。**

### 11.2 根本原因假設
1. **假設 1：** Google Custom Search API 調用失敗，但錯誤被吞掉
2. **假設 2：** 前端「所有來源」邏輯不完整，沒有嘗試 Google Custom Search
3. **假設 3：** 兩個圖片服務類的行為不一致，導致問題
4. **假設 4：** API 端點實現有問題，沒有正確使用 ImageServiceManager

### 11.3 需要專家確認
1. **架構設計是否合理？**
2. **實現方式是否正確？**
3. **錯誤處理策略是否適當？**
4. **診斷方法是否有效？**

---

## 12. 附件

### 12.1 相關代碼文件
- `backend/app/api/v1/images.py`
- `backend/app/services/images/image_service_manager.py`
- `backend/app/services/images/image_service.py`
- `backend/app/services/images/google_custom_search.py`
- `frontend/src/components/features/ImageSearch.tsx`
- `frontend/src/api/images.ts`

### 12.2 相關日誌
- Railway 部署日誌
- 瀏覽器控制台錯誤日誌
- API 請求/響應日誌（如有）

### 12.3 配置資訊
- Railway 環境變數配置
- Google Custom Search API 配置
- 前端環境變數配置

---

## 13. 聯繫資訊

**項目資訊：**
- 項目名稱：AI Agent Webapp
- 後端部署：Railway (gentle-enchantment-production-1865.up.railway.app)
- 前端部署：Vercel (ai-agent-webapp-ten.vercel.app)
- GitHub：https://github.com/adamau1983119/AI_Agent_Webapp

**問題報告人：**
- 開發團隊

---

## 14. 專家審查請求

**請第三方專家重點審查以下方面：**

1. **架構設計審查**
   - 圖片服務架構是否合理？
   - 備援機制設計是否正確？
   - 是否有更好的設計方案？

2. **實現審查**
   - Google Custom Search API 調用實現是否正確？
   - 錯誤處理邏輯是否適當？
   - 前端後端同步是否正確？

3. **問題診斷**
   - 根據現有資訊，最可能的問題原因是什麼？
   - 應該如何診斷和定位問題？
   - 需要哪些額外的資訊？

4. **改善建議**
   - 短期內如何快速修復問題？
   - 長期如何改善架構和實現？
   - 有哪些最佳實踐可以應用？

---

**報告結束**

*本報告旨在提供全面的問題資訊，協助第三方專家進行審查並提供改善建議。*

