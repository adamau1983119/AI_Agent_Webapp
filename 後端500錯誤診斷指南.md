# 後端 500 錯誤診斷指南

## 🔍 問題描述

前端 Console 顯示：
```
GET https://gentle-enchantment-production-1865.up.railway.app/api/v1/schedules/generate-today 500 (Internal Server Error)
API Error: {message: '伺服器內部錯誤', status: 500, code: 'INTERNAL_ERROR'}
```

**注意**：雖然 Console 顯示 `GET`，但前端代碼正確使用 `POST`。這可能是瀏覽器顯示問題或重試機制。

---

## 📋 診斷步驟

### 步驟 1：檢查 Railway 後端日誌

1. **訪問 Railway Dashboard**：
   - https://railway.app/dashboard
   - 選擇專案：`gentle-enchantment`

2. **查看 Logs**：
   - 點擊專案 → 選擇服務 → 點擊「Logs」標籤
   - 或直接訪問：https://railway.app/project/[project-id]/service/[service-id]/logs

3. **查找錯誤訊息**：
   - 搜索關鍵字：`generate-today`、`500`、`ERROR`、`Exception`
   - 查看最近的錯誤堆疊追蹤

4. **記錄錯誤訊息**：
   - 複製完整的錯誤訊息和堆疊追蹤
   - 特別注意：
     - MongoDB 連接錯誤
     - AI 服務 API Key 錯誤
     - 圖片服務 API Key 錯誤
     - 其他異常訊息

---

### 步驟 2：檢查常見錯誤原因

#### 2.1 MongoDB 連接問題

**症狀**：
- 錯誤訊息包含：`MongoClient`、`Connection refused`、`Timeout`、`Authentication failed`
- 日誌顯示：`無法連接到 MongoDB`

**檢查**：
1. 訪問 Railway → Settings → Variables
2. 確認 `MONGODB_URL` 是否設置
3. 確認 `MONGODB_URL` 值是否正確（格式：`mongodb+srv://...` 或 `mongodb://...`）

**解決方案**：
- 如果 `MONGODB_URL` 未設置，添加正確的 MongoDB 連接字串
- 如果值不正確，更新為正確的連接字串
- 確認 MongoDB Atlas（如果使用）的 IP 白名單包含 Railway 的 IP

---

#### 2.2 AI 服務 API Key 問題

**症狀**：
- 錯誤訊息包含：`API Key 未設定`、`Invalid API Key`、`Unauthorized`
- 日誌顯示：`QWEN_API_KEY` 或 `OPENAI_API_KEY` 相關錯誤

**檢查**：
1. 訪問 Railway → Settings → Variables
2. 確認當前使用的 AI 服務的 API Key 是否設置：
   - 如果 `AI_SERVICE=qwen`，檢查 `QWEN_API_KEY`
   - 如果 `AI_SERVICE=openai`，檢查 `OPENAI_API_KEY`
   - 如果 `AI_SERVICE=gemini`，檢查 `GEMINI_API_KEY`

**解決方案**：
- 如果 API Key 未設置，添加正確的 API Key
- 如果 API Key 無效，更新為有效的 API Key
- 確認 API Key 有足夠的額度或權限

---

#### 2.3 圖片服務 API Key 問題

**症狀**：
- 錯誤訊息包含：`圖片服務全部失敗`、`UNSPLASH_ACCESS_KEY`、`PEXELS_API_KEY`
- 日誌顯示：圖片搜尋失敗（但這不應該導致 500 錯誤）

**檢查**：
1. 訪問 Railway → Settings → Variables
2. 確認至少一個圖片服務的 API Key 已設置：
   - `UNSPLASH_ACCESS_KEY`
   - `PEXELS_API_KEY`
   - `PIXABAY_API_KEY`

**解決方案**：
- 如果所有圖片服務 API Key 都未設置，至少添加一個
- 圖片服務失敗不會導致 500 錯誤，但會影響圖片生成功能

---

#### 2.4 其他錯誤

**可能原因**：
- 代碼錯誤（語法錯誤、邏輯錯誤）
- 依賴包缺失或版本不兼容
- 環境變數格式錯誤
- 資源限制（記憶體、CPU）

**檢查**：
- 查看完整的錯誤堆疊追蹤
- 檢查 Railway Logs 中的詳細錯誤訊息

---

## 🔧 快速修復步驟

### 修復 1：檢查並設置必要的環境變數

訪問 Railway → Settings → Variables，確認以下環境變數已設置：

**必須設置**：
- [ ] `MONGODB_URL` - MongoDB 連接字串
- [ ] `AI_SERVICE` - AI 服務名稱（如 `qwen`、`openai`）
- [ ] `QWEN_API_KEY` 或 `OPENAI_API_KEY` 或 `GEMINI_API_KEY`（根據 `AI_SERVICE`）
- [ ] `ENVIRONMENT` - 應設置為 `production`
- [ ] `AUTO_START_SCHEDULER` - 應設置為 `true`

**建議設置**：
- [ ] `UNSPLASH_ACCESS_KEY` 或 `PEXELS_API_KEY` 或 `PIXABAY_API_KEY`（至少一個）
- [ ] `CORS_ORIGINS` - 應包含 `https://ai-agent-webapp-ten.vercel.app`

---

### 修復 2：重新部署後端

如果環境變數已設置但仍有錯誤：

1. **觸發重新部署**：
   - 訪問 Railway → Deployments
   - 點擊最新部署右側的「...」選單
   - 選擇「Redeploy」

2. **或推送一個小改動**：
   ```bash
   cd backend
   # 創建一個空提交來觸發重新部署
   git commit --allow-empty -m "trigger: Redeploy backend"
   git push origin main
   ```

---

### 修復 3：檢查後端健康狀態

1. **訪問健康檢查端點**：
   - https://gentle-enchantment-production-1865.up.railway.app/health
   - 或：https://gentle-enchantment-production-1865.up.railway.app/api/v1/health/detailed

2. **檢查響應**：
   - 應該返回 JSON 格式的健康狀態
   - 檢查各個服務的狀態（MongoDB、AI 服務、圖片服務等）

---

## 📊 錯誤日誌分析

### 常見錯誤模式

#### 模式 1：MongoDB 連接失敗
```
pymongo.errors.ServerSelectionTimeoutError: ...
或
pymongo.errors.ConfigurationError: ...
```

**解決方案**：檢查 `MONGODB_URL` 設置

---

#### 模式 2：AI 服務 API Key 錯誤
```
ValueError: QWEN_API_KEY 未設定
或
openai.error.AuthenticationError: ...
```

**解決方案**：檢查對應的 AI 服務 API Key

---

#### 模式 3：代碼錯誤
```
AttributeError: ...
或
TypeError: ...
或
KeyError: ...
```

**解決方案**：檢查代碼是否有錯誤，查看完整的堆疊追蹤

---

## 🎯 下一步行動

### 立即行動（5 分鐘內）

1. **訪問 Railway Logs**：
   - 查看最新的錯誤日誌
   - 記錄完整的錯誤訊息

2. **檢查環境變數**：
   - 確認所有必要的環境變數已設置
   - 確認值是否正確

3. **告訴我結果**：
   - 錯誤日誌中的具體錯誤訊息是什麼？
   - 哪些環境變數可能缺失或錯誤？

---

### 根據錯誤類型採取行動

**如果是 MongoDB 連接問題**：
- 檢查 `MONGODB_URL` 設置
- 確認 MongoDB Atlas IP 白名單

**如果是 AI 服務問題**：
- 檢查對應的 API Key
- 確認 API Key 有效且有額度

**如果是代碼錯誤**：
- 查看完整的堆疊追蹤
- 檢查相關代碼文件

---

## 📝 檢查清單

### 環境變數檢查
- [ ] `MONGODB_URL` 已設置且正確
- [ ] `AI_SERVICE` 已設置
- [ ] 對應的 AI 服務 API Key 已設置
- [ ] `ENVIRONMENT` = `production`
- [ ] `AUTO_START_SCHEDULER` = `true`
- [ ] `CORS_ORIGINS` 包含前端 URL

### 後端狀態檢查
- [ ] Railway 服務狀態為 Active
- [ ] 健康檢查端點返回正常
- [ ] 日誌中沒有持續的錯誤

### 功能測試
- [ ] `/api/v1/schedules/generate-today` 端點能正常響應
- [ ] 主題生成功能正常
- [ ] 內容生成功能正常

---

## 🔗 相關資源

- **Railway Dashboard**：https://railway.app/dashboard
- **後端健康檢查**：https://gentle-enchantment-production-1865.up.railway.app/health
- **詳細健康檢查**：https://gentle-enchantment-production-1865.up.railway.app/api/v1/health/detailed

---

**最後更新**：2025-12-30

